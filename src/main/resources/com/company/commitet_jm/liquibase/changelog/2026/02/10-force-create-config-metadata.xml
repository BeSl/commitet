<?xml version="1.0" encoding="UTF-8"?>
<databaseChangeLog
        xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
        xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
        xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog
                      http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-latest.xsd">

    <changeSet id="force-create-config-metadata-item" author="commitet_jm" runOnChange="true">
        <sql>
            CREATE TABLE IF NOT EXISTS CONFIG_METADATA_ITEM (
                ID UUID NOT NULL PRIMARY KEY,
                EXTERNAL_ID VARCHAR(255),
                NAME VARCHAR(255) NOT NULL,
                METADATA_TYPE VARCHAR(255),
                IS_COLLECTION BOOLEAN DEFAULT FALSE,
                SORT_ORDER INT DEFAULT 0,
                FULL_PATH VARCHAR(1000),
                PARENT_ID UUID,
                PROJECT_ID UUID NOT NULL,
                VERSION INT NOT NULL
            )
        </sql>
    </changeSet>

    <changeSet id="force-create-indexes-config-metadata" author="commitet_jm" runOnChange="true">
        <sql>
            CREATE INDEX IF NOT EXISTS IDX_CMI_PROJECT ON CONFIG_METADATA_ITEM(PROJECT_ID);
            CREATE INDEX IF NOT EXISTS IDX_CMI_PARENT ON CONFIG_METADATA_ITEM(PARENT_ID);
            CREATE INDEX IF NOT EXISTS IDX_CMI_EXTERNAL_ID ON CONFIG_METADATA_ITEM(EXTERNAL_ID);
            CREATE INDEX IF NOT EXISTS IDX_CMI_FULL_PATH ON CONFIG_METADATA_ITEM(FULL_PATH)
        </sql>
    </changeSet>

    <changeSet id="force-create-fk-config-metadata-project" author="commitet_jm" runOnChange="true" failOnError="false">
        <sql>
            ALTER TABLE CONFIG_METADATA_ITEM ADD CONSTRAINT FK_CONFIG_METADATA_ITEM_ON_PROJECT
                FOREIGN KEY (PROJECT_ID) REFERENCES PROJECT(ID)
        </sql>
    </changeSet>

    <changeSet id="force-create-fk-config-metadata-parent" author="commitet_jm" runOnChange="true" failOnError="false">
        <sql>
            ALTER TABLE CONFIG_METADATA_ITEM ADD CONSTRAINT FK_CONFIG_METADATA_ITEM_ON_PARENT
                FOREIGN KEY (PARENT_ID) REFERENCES CONFIG_METADATA_ITEM(ID)
        </sql>
    </changeSet>

</databaseChangeLog>
